{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-8">
    <div class="mb-2 d-flex flex-wrap gap-2">
      <a class="btn btn-outline-secondary {% if not selected_cat %}active{% endif %}" href="?">Todas</a>
      {% for c in categories %}
        <a class="btn btn-outline-secondary {% if selected_cat == c.id %}active{% endif %}" href="?cat={{ c.id }}">{{ c.name }}</a>
      {% endfor %}
    </div>
    <div class="row row-cols-2 row-cols-md-3 g-3">
      {% for p in products %}
      <div class="col">
        <div class="card h-100 product-card">
          <div class="card-body">
            <h6 class="card-title">{{ p.name }}</h6>
            <p class="card-text mb-2"><span class="badge text-bg-primary">${{ p.price }}</span></p>
            <form method="post" action="{% url 'pos:add' p.id %}">
              {% csrf_token %}
              <button class="btn btn-sm btn-success w-100">Agregar</button>
            </form>
          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-muted">No hay productos.</p>
      {% endfor %}
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">Carrito</div>
      <div class="card-body">
        {% if items %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead><tr><th>Producto</th><th class="text-end">Cant</th><th class="text-end">Subtotal</th><th></th></tr></thead>
              <tbody>
              {% for it in items %}
                <tr>
                  <td>{{ it.product.name }}</td>
                  <td class="text-end">
                    <form method="post" action="{% url 'pos:dec' it.product.id %}" class="d-inline">{% csrf_token %}<button class="btn btn-sm btn-outline-secondary">−</button></form>
                    <span class="mx-1">{{ it.qty }}</span>
                    <form method="post" action="{% url 'pos:add' it.product.id %}" class="d-inline">{% csrf_token %}<button class="btn btn-sm btn-outline-secondary">+</button></form>
                  </td>
                  <td class="text-end">${{ it.line_total }}</td>
                  <td class="text-end">
                    <form method="post" action="{% url 'pos:rm' it.product.id %}">{% csrf_token %}
                      <button class="btn btn-sm btn-outline-danger">X</button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between border-top pt-2">
            <strong>Total</strong>
            <strong>${{ total }}</strong>
          </div>
          <hr>
          <form method="post" action="{% url 'pos:checkout' %}">
            {% csrf_token %}
            <div class="mb-2">
              {{ checkout_form.payment_method.label_tag }}<br>
              {{ checkout_form.payment_method }}
            </div>
            <div id="cash-area" class="mb-2">
              <label for="id_cash_given" class="form-label">Efectivo recibido</label>
              {{ checkout_form.cash_given }}
              <div class="money-btns mt-2">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCash(20)">+$20</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCash(50)">+$50</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCash(100)">+$100</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCash(200)">+$200</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setCash(500)">+$500</button>
              </div>
              <div id="cash-hint" class="form-text"></div>
            </div>

            <div class="d-flex gap-2">
              <button class="btn btn-primary w-100" type="submit">Registrar venta</button>
              <form method="post" action="{% url 'pos:clear' %}">{% csrf_token %}
                <button class="btn btn-outline-secondary">Vaciar</button>
              </form>
            </div>
          </form>
          <script>
            // Mostrar/ocultar efectivo según método seleccionado
            (function(){
              const radios = document.querySelectorAll('input[name="payment_method"]');
              const cashArea = document.getElementById('cash-area');
              function toggle() {
                const v = Array.from(radios).find(r=>r.checked)?.value;
                cashArea.style.display = (v === 'cash') ? 'block' : 'none';
              }
              radios.forEach(r=>r.addEventListener('change', toggle));
              toggle();
            })();
          </script>
          <script>
            (function(){
              const total = parseFloat('{{ total|floatformat:2 }}');
              const cashInput = document.getElementById('id_cash_given');
              const hint = document.getElementById('cash-hint');
              const radios = document.querySelectorAll('input[name="payment_method"]');

              function updateHint(){
                if(!cashInput) return;
                const v = parseFloat(cashInput.value || 0);
                if (isNaN(v)) { hint.textContent = ''; return; }
                const diff = (v - total);
                if (diff >= 0) {
                  hint.textContent = 'Cambio estimado: $' + diff.toFixed(2);
                } else {
                  hint.textContent = 'Falta: $' + Math.abs(diff).toFixed(2);
                }
              }

              // Solo mostrar/actualizar si es efectivo
              function toggle(){
                const method = Array.from(radios).find(r=>r.checked)?.value;
                const cashArea = document.getElementById('cash-area');
                const show = (method === 'cash');
                if (cashArea) cashArea.style.display = show ? 'block' : 'none';
                if (show) updateHint();
              }

              if (cashInput) {
                cashInput.addEventListener('input', updateHint);
              }
              radios.forEach(r=>r.addEventListener('change', toggle));
              toggle(); // init
            })();
        </script>

        {% else %}
          <p class="text-muted">Agrega productos para iniciar una venta.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
